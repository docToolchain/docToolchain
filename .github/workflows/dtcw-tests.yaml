name: Execute dtcw test suite

on:
  push:
    branches-ignore:
      - gh-pages
  pull_request:
    branches: [ ng ]
    paths:
      - 'dtcw'
      - 'test/**'
  workflow_dispatch: {}

jobs:
  shellcheck:
    name: ShellCheck - shell script linter
    runs-on: ubuntu-latest
    steps:
      - name: Install used packages
        run: sudo apt-get -qq -y --no-install-recommends install curl ca-certificates ncurses-bin xz-utils
      - uses: actions/checkout@v3
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          ignore_paths: >-
            ./.git/*
            ./test/*
            ./gradlew

  test-dtcw:
    needs: shellcheck
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false
    name: Execute dtcw test suite - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Clean out dirctory
        # Remove all files except the system under test and the test code.
        run: |
          find . -maxdepth 1 -type d -not -name '.' -not -name 'test' -print0 | xargs -0 rm -rf --
          find . -maxdepth 1 -type f -not -name 'dtcw' -not -name 'test' -print0 | xargs -0 rm --
      - name: Run tests
        run: |
          echo $BASH_VERSION
          test/bats/bin/bats --filter-tags \!e2e test

  test-dtcw-ps1:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    name: Execute dtcw test suite on pwsh - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: pwsh
    steps:
      - name: install pwsh
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "pwsh already installed"
          else  
            sudo apt-get install -y wget apt-transport-https software-properties-common
            wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
            sudo dpkg -i packages-microsoft-prod.deb
            rm packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
      #- name: Clean out dirctory
        # Remove all files except the system under test and the test code.
        # run: |
          # Get-ChildItem -Directory -Path . -Exclude '.', 'test' -Recurse -Force | Remove-Item -Recurse -Force
          # Get-ChildItem -File -Path . -Exclude 'dtcw', 'test' -Force | Remove-Item -Force ``
      - name: remove dtcw (bash)
        run: |
          rm ./dtcw
      - name: Run tests
        run: |
          echo $BASH_VERSION
          test/bats/bin/bats --filter-tags \!e2e test

  test-dtcw-ps1-spock:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        java: [14]
        jdk: [temurin]
      fail-fast: false
    name: Execute dtcw test suite on pwsh - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Run tests
        run: |
          ./gradlew test --info --tests=DtcwOnPowershellSpec
